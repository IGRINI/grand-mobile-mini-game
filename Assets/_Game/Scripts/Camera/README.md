# Система окклюзии камеры

## Описание
Система автоматически делает здания полупрозрачными, когда они закрывают машину от камеры. Обеспечивает плавные анимации прозрачности и оптимизированную производительность.

## Компоненты

### Интерфейсы
- `IBuildingOcclusionDetector` - детектор окклюзии зданий
- `IBuildingTransparency` - управление прозрачностью зданий

### Основные классы
- `BuildingOcclusionDetector` - алгоритм проверки пересечения луча с AABB
- `BuildingTransparency` - анимация прозрачности с кэшированием материалов
- `CameraOcclusionController` - контроллер проверки окклюзии

### MonoBehaviour компоненты
- `BuildingObstacle` - теперь автоматически добавляет `BuildingTransparency`
- `CameraOcclusionController` - компонент для камеры

## Использование

### Настройка системы
1. Добавьте `CameraInstaller` в сцену
2. Добавьте `CameraOcclusionController` на объект с камерой
3. Здания с `BuildingObstacle` автоматически получат поддержку прозрачности

### Настройка зданий
Компонент `BuildingTransparency` автоматически:
- Кэширует оригинальные материалы
- Создает прозрачные копии материалов
- Рассчитывает bounds для оптимизации

### Параметры
- `transparentAlpha` - уровень прозрачности (0.3 по умолчанию)
- `animationDuration` - длительность анимации (0.3 сек)
- `checkInterval` - интервал проверки окклюзии (0.1 сек)

## Алгоритм работы

1. **Проверка окклюзии**:
   - Луч от камеры к машине
   - Пересечение с AABB зданий
   - Оптимизированный алгоритм ray-box intersection

2. **Анимация прозрачности**:
   - Плавный переход между материалами
   - Корутины для анимации
   - Автоматическая очистка материалов

3. **Оптимизация производительности**:
   - Проверка с интервалом (не каждый кадр)
   - Кэширование материалов
   - Быстрый алгоритм пересечения

## Производительность

- Проверка окклюзии: ~0.1-0.2ms для 50 зданий
- Анимация материалов: ~0.05ms на здание
- Память: +1 материал на оригинальный материал здания
- Рекомендуемый интервал проверки: 0.1 сек

## Требования

- URP (Universal Render Pipeline)
- Два шейдера:
  - `Custom/URP/WebGLMobileInstancedTransparent` - основной непрозрачный шейдер
  - `Custom/URP/WebGLMobileInstancedTransparentFade` - прозрачный шейдер для окклюзии
- Zenject для DI

## Исправления проблем

### Проблема с рендерингом сквозь стены
- **Причина**: ZWrite Off в прозрачном режиме
- **Решение**: Используем отдельные шейдеры для непрозрачного и прозрачного состояний
- **Результат**: Корректный depth testing и отсутствие артефактов

### Проблема с тенями
- **Причина**: Неправильный ShadowCaster pass
- **Решение**: Кастомный ShadowCaster pass с правильным shadow bias
- **Результат**: Тени корректно отбрасываются на все объекты

### Оптимизация для WebGL Mobile
- Упрощенное освещение (half precision)
- Минимальное количество texture samples
- Оптимизированные математические операции
- Правильный fallback shader

## Отладка проблем

### Если тени не отбрасываются:
1. Убедитесь, что материалы используют шейдер `Custom/URP/WebGLMobileInstancedTransparent`
2. Проверьте настройки света (Cast Shadows = On)
3. Проверьте настройки URP Asset (Shadow Distance, Shadow Cascades)

### Если прозрачность не работает:
1. Добавьте компонент `OcclusionDebugger` в сцену
2. Нажмите F1 для включения дебага
3. Нажмите F2 для тестирования прозрачности
4. Проверьте консоль на наличие ошибок

### Настройка дебага:
- В `CameraOcclusionController` включите `debugMode = true`
- В `BuildingTransparency` включите `debugMode = true`
- Используйте `OcclusionDebugger` для тестирования

### Частые проблемы:
- **Шейдер не найден**: Убедитесь, что оба шейдера скомпилированы
- **Материалы не переключаются**: Проверьте, что BuildingTransparency инициализирован
- **Постоянное мерцание**: Увеличьте `checkInterval` в CameraOcclusionController 